---
import Layout from '../layouts/Layout.astro';
import { Image } from 'astro:assets'; // <--- NEW: Import the Image component
import galleryDataRaw from '../data/gallery_data.json';
import GalleryItem from '../components/GalleryItem.astro';

// 1. Load all images from src/assets
// This creates a list of every image file in your folder
const imageFiles = import.meta.glob<{ default: ImageMetadata }>('/src/assets/**/*.{jpeg,jpg,png,tiff,webp}');

// 2. Sort Data (Same as before)
const sortedData = galleryDataRaw.sort((a, b) => {
    const d1 = new Date(a.year, a.month - 1, a.day);
    const d2 = new Date(b.year, b.month - 1, b.day);
    return d2.getTime() - d1.getTime(); 
});

// 3. Helper to find the image file based on JSON path
function getImagePath(srcPath) {
    // We assume your JSON says "assets/2025/..."
    // We need to match it to "/src/assets/2025/..."
    const fullPath = `/src/${srcPath}`;
    
    if (!imageFiles[fullPath]) {
        console.error(`Image not found: ${fullPath}`);
        return null; // Handle missing images gracefully
    }
    return imageFiles[fullPath]();
}

// 4. Group by Year (Same as before)
const grouped = sortedData.reduce((acc, item) => {
    (acc[item.year] = acc[item.year] || []).push(item);
    return acc;
}, {});

const years = Object.keys(grouped).sort((a, b) => b - a);
const categories = [...new Set(sortedData.map(item => item.category).filter(c => c))].sort();
---

<Layout>
    <!-- 0. BACKGROUND PARTICLES -->
    <canvas id="bg-canvas"></canvas>

    <!-- 1. BLACK HOLE & SUPERNOVA LOADER -->
    <div id="loader-overlay">
        <div class="accretion-disk"></div>
    </div>

    <!-- 2. NAVIGATION -->
    <nav id="navbar">
        <div class="nav-left">
            <span class="site-title">I. LOPEZ</span>
        </div>
        
        <div class="nav-center">
            <button class="menu-btn active" id="btn-gallery">GALERÍA</button>
            <button class="menu-btn" id="btn-universe">MI UNIVERSO</button>
        </div>

        <div class="nav-right">
            <div class="lang-select">
                <span id="lang-en" class="lang">EN</span> / 
                <span id="lang-es" class="lang active">ES</span>
            </div>
        </div>
    </nav>

    <!-- 3. SCROLL TO TOP ARROW -->
    <button id="scroll-top-btn" onclick="window.scrollTo({top: 0, behavior: 'smooth'})" aria-label="Scroll to top">
        <i class="fas fa-chevron-up"></i>
    </button>

    <!-- 4. MAIN CONTENT -->
    <main class="content-container">

        <!-- GALLERY TAB -->
        <section id="gallery-tab" class="fade-in">
            
            <header class="gallery-header">
                <div class="quote-container">
                    <h1 id="quote-text" class="philosophical-quote">"Estamos hechos de polvo de estrellas."</h1>
                    <p id="quote-author" class="quote-author">- Carl Sagan</p>
                </div>
                
                <!-- Scrollable Filters Container -->
                <div class="filters-wrapper">
                    <div class="filters">
                        <button class="filter-btn active" data-filter="all" data-t="filter_all">All</button>
                        {categories.map(cat => (
                            <button class="filter-btn" data-filter={cat} data-t={`cat_${cat.toLowerCase()}`}>{cat}</button>
                        ))}
                    </div>
                </div>
            </header>

            <!-- Dynamic Gallery Container (Generated by Astro) -->
            <div id="dynamic-gallery-root">
                {years.map(year => (
                    <div class="year-section" id={`year-${year}`}>
                        <h2 class="year-title">{year}</h2>
                        <div class="gallery-grid">
                            {grouped[year].map(item => (
                                <GalleryItem item={item} imagePromise={getImagePath(item.src)} />
                            ))}
                        </div>
                    </div>
                ))}
            </div>

        </section>

        <!-- PORTFOLIO TAB -->
        <section id="portfolio-tab" class="hidden">
            
            <div class="story-container">
                <div class="story-row">
                    <div class="story-img">
                        <img src="assets/2015/IMG-20150719-WA0000_thumb.webp" 
                             alt="First sky image" 
                             loading="lazy"
                             onerror="this.onerror=null; this.src='assets/2015/IMG-20150719-WA0000.jpg';">
                    </div>
                    <div class="story-text">
                        <h3 data-t="story1_title">The Origin</h3>
                        <p data-t="story1_text">In 2015, in high school, we were assigned to photograph something that reminded us of philosophy. I took this photo, unaware that it would lead me to who I am today. I wrote about loneliness, saying it could destroy us or allow us to appreciate things much more.</p>
                    </div>
                </div>

                <div class="story-row reverse">
                    <div class="story-text">
                        <h3 data-t="story2_title">The Gravity</h3>
                        <p data-t="story2_text">I related it to the stars, which, no matter how isolated they are, never stop shining. Since that moment, my love for the universe has never stopped expanding. That intrigue for the unknown was subjected to the pull of my gravity.</p>
                    </div>
                    <div class="story-img">
                        <img src="assets/2024/IMG_1545_thumb.webp" 
                             alt="Sunset" 
                             loading="lazy"
                             onerror="this.onerror=null; this.src='assets/2024/IMG_1545.jpeg';">
                    </div>
                </div>

                <div class="story-row">
                    <div class="story-img">
                        <img src="assets/2024/IMG_0329_thumb.webp" 
                             alt="Moon telescope" 
                             loading="lazy"
                             onerror="this.onerror=null; this.src='assets/2024/IMG_0329.jpeg';">
                    </div>
                    <div class="story-text">
                        <h3 data-t="story3_title">The History</h3>
                        <p data-t="story3_text">Allowing the release of energy from the event horizon, which ended up forming a great star cluster. An image is worth a thousand words, and all of these will form my history.</p>
                    </div>
                </div>
            </div>

            <!-- 4th Image: Parallax Separator -->
            <div class="parallax-divider" style="background-image: url('assets/EclipseUs.jpg');"></div>

            <!-- EQUIPMENT SECTION -->
            <div class="equipment-wrapper">
                <h2 class="cv-main-title" data-t="equip_title">My Equipment</h2>
                <div class="equipment-grid">
                    <div class="equip-item">
                        <i class="fas fa-satellite-dish"></i>
                        <span class="equip-label" data-t="eq_dig_tel">Digital Telescope</span>
                        <span class="equip-val">Seestar S30 Pro</span>
                    </div>
                    <div class="equip-item">
                        <i class="fas fa-binoculars"></i>
                        <span class="equip-label" data-t="eq_tel">Telescope</span>
                        <span class="equip-val">Nassa X210</span>
                    </div>
                    <div class="equip-item">
                        <i class="fas fa-camera"></i>
                        <span class="equip-label" data-t="eq_cam">Camera</span>
                        <span class="equip-val">Olympus E420</span>
                    </div>
                    <div class="equip-item">
                        <i class="fas fa-map-marker-alt"></i>
                        <span class="equip-label" data-t="eq_tripod">Tripod</span>
                        <span class="equip-val">...</span>
                    </div>
                    <div class="equip-item">
                        <i class="fas fa-compass"></i>
                        <span class="equip-label" data-t="eq_mount">Eq Mount</span>
                        <span class="equip-val">...</span>
                    </div>
                </div>
            </div>

            <div class="cv-wrapper">
                <h2 class="cv-main-title" data-t="profile_title">Professional Profile</h2>
                
                <div class="cv-grid">
                    <div class="cv-col">
                        <h4 class="cv-section-head" data-t="exp_title">Experience</h4>
                        <div class="cv-item">
                            <span class="cv-role" data-t="job1_role">AI Engineer & Architect</span>
                            <span class="cv-place" data-t="job1_place">Multinational Hospitality Group</span>
                            <span class="cv-date" data-t="job1_date">May 2025 - Present</span>
                            <p data-t="job1_desc">Leading AI adoption strategies, defining corporate governance for Generative AI, and deploying LLM solutions (Gemini) across global departments to automate complex workflows.</p>
                        </div>
                        <div class="cv-item">
                            <span class="cv-role" data-t="job2_role">Data Scientist</span>
                            <span class="cv-place" data-t="job2_place">Engineering & Innovation Firm</span>
                            <span class="cv-date" data-t="job2_date">Apr 2024 - Oct 2024</span>
                            <p data-t="job2_desc">Developed Computer Vision models (YOLO, Detectron) to digitize road infrastructure assets from terabytes of visual data. Built deep learning pipelines for object detection.</p>
                        </div>
                        <div class="cv-item">
                            <span class="cv-role" data-t="job3_role">Data Analyst</span>
                            <span class="cv-place" data-t="job3_place">Public Utility Services</span>
                            <span class="cv-date" data-t="job3_date">Oct 2022 - May 2023</span>
                            <p data-t="job3_desc">Optimized fleet efficiency and environmental reporting using BI tools and statistical analysis for large-scale urban infrastructure.</p>
                        </div>
                    </div>

                    <div class="cv-col">
                        <h4 class="cv-section-head" data-t="skills_title">Core Competencies</h4>
                        <ul class="skills-list">
                            <li>Deep Learning (PyTorch, TensorFlow)</li>
                            <li>Generative AI & LLMs</li>
                            <li>Computer Vision & Image Processing</li>
                            <li>Cloud Architecture (GCP, AWS)</li>
                            <li>Python, SQL, Docker</li>
                            <li>Big Data Platforms (Hadoop, Spark)</li>
                        </ul>

                        <h4 class="cv-section-head mt-large" data-t="edu_title">Education</h4>
                        <div class="cv-item">
                            <span class="cv-role" data-t="edu1_role">Master in Artificial Intelligence</span>
                            <span class="cv-place" data-t="edu1_place">University of the Balearic Islands</span>
                            <span class="cv-date">2023 - 2024</span>
                        </div>
                        <div class="cv-item">
                            <span class="cv-role" data-t="edu2_role">B.S. Industrial Electronics Engineering</span>
                            <span class="cv-place" data-t="edu2_place">University of the Balearic Islands</span>
                            <span class="cv-date">2017 - 2023</span>
                        </div>
                    </div>
                </div>
            </div>
        </section>
        
        <!-- GLOBAL CONTACT FOOTER -->
        <footer class="contact-footer">
            <p class="contact-quote" data-t="contact_quote">"Somewhere, something incredible is waiting to be known."</p>
            <div class="contact-icons">
                <a href="mailto:ivan1999spain@gmail.com" aria-label="Email"><i class="fas fa-envelope"></i></a>
                <a href="https://linkedin.com/in/lmivan" target="_blank" aria-label="LinkedIn"><i class="fab fa-linkedin"></i></a>
                <a href="https://github.com/IvanLM99" target="_blank" aria-label="GitHub"><i class="fab fa-github"></i></a>
            </div>
            <p class="copyright">© 2026 Iván López</p>
        </footer>

    </main>

    <!-- LIGHTBOX -->
    <div id="lightbox">
        <span class="close-lb" onclick="closeLightbox()" aria-label="Close Lightbox">&times;</span>
        <button class="lb-nav-btn prev-btn" aria-label="Previous Image"><i class="fas fa-chevron-left"></i></button>
        <button class="lb-nav-btn next-btn" aria-label="Next Image"><i class="fas fa-chevron-right"></i></button>

        <div class="lb-content">
            <div class="lb-image-wrapper">
                <div class="lb-image-container">
                    <img id="lb-img" src="" alt="Expanded View">
                </div>
            </div>
            
            <div class="lb-info">
                <h2 id="lb-title">Object Name</h2>
                
                <div id="lb-story-container" class="lb-story">
                    <i class="fas fa-quote-left story-icon"></i>
                    <p id="lb-story-text"></p>
                </div>

                <div class="tech-specs">
                    <div class="spec" id="spec-obj">
                        <span data-t="lb_obj">OBJECT</span>
                        <span id="val-obj">--</span>
                    </div>
                    <div class="spec" id="spec-date">
                        <span data-t="lb_date">DATE</span>
                        <span id="val-date">--</span>
                    </div>
                    <div class="spec" id="spec-exp">
                        <span data-t="lb_exp">EXPOSURE</span>
                        <span id="val-exp">--</span>
                    </div>
                    <div class="spec" id="spec-equip">
                        <span data-t="lb_equip">EQUIPMENT</span>
                        <span id="val-equip">--</span>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- CLIENT SIDE SCRIPTS -->
    <script>
        /* === TRANSLATIONS DATA === */
        const translations = {
            "en": {
                "nav_gallery": "GALLERY", "nav_portfolio": "MY UNIVERSE", "details": "DETAILS",
                "story1_title": "The Origin",
                "story1_text": "In 2015, in high school, we were assigned to photograph something that reminded us of philosophy. I took this photo, unaware that it would lead me to who I am today. I wrote about loneliness, saying it could destroy us or allow us to appreciate things much more.",
                "story2_title": "The Gravity",
                "story2_text": "I related it to the stars, which, no matter how isolated they are, never stop shining. Since that moment my love for the universe has never stopped expanding. That intrigue for the unknown was subjected to the pull of my gravity.",
                "story3_title": "The History",
                "story3_text": "Allowing the release of energy from the event horizon, which ended up forming a great star cluster. An image is worth a thousand words, and all of these will form my history.",
                "equip_title": "My Equipment", "eq_dig_tel": "Digital Telescope", "eq_tel": "Telescope", "eq_cam": "Camera", "eq_tripod": "Tripod", "eq_mount": "Eq Mount",
                "profile_title": "Professional Profile", "exp_title": "Experience", "skills_title": "Core Competencies", "edu_title": "Education",
                "job1_role": "AI Engineer & Architect", "job1_place": "Multinational Hospitality Group", "job1_date": "May 2025 - Present",
                "job1_desc": "Leading AI adoption strategies, defining corporate governance for Generative AI, and deploying LLM solutions (Gemini) across global departments to automate complex workflows.",
                "job2_role": "Data Scientist", "job2_place": "Engineering & Innovation Firm", "job2_date": "Apr 2024 - Oct 2024",
                "job2_desc": "Developed Computer Vision models (YOLO, Detectron) to digitize road infrastructure assets from terabytes of visual data. Built deep learning pipelines for object detection.",
                "job3_role": "Data Analyst", "job3_place": "Public Utility Services", "job3_date": "Oct 2022 - May 2023",
                "job3_desc": "Optimized fleet efficiency and environmental reporting using BI tools and statistical analysis for large-scale urban infrastructure.",
                "edu1_role": "Master in Artificial Intelligence", "edu1_place": "University of the Balearic Islands",
                "edu2_role": "B.S. Industrial Electronics Engineering", "edu2_place": "University of the Balearic Islands",
                "contact_quote": "\"Somewhere, something incredible is waiting to be known.\"",
                "lb_obj": "OBJECT", "lb_date": "DATE", "lb_exp": "EXPOSURE", "lb_equip": "EQUIPMENT",
                "zoom_hint": "Scroll to zoom, Drag to pan", "filter_all": "All",
                "cat_moon": "Moon", "cat_dso": "Deep Sky", "cat_landscape": "Landscape", "cat_planets": "Planets",
                "cat_nebulae": "Nebulae", "cat_galaxies": "Galaxies", "cat_starclusters": "Star Clusters", "cat_solar": "Solar", "cat_sky": "Sky"
            },
            "es": {
                "nav_gallery": "GALERÍA", "nav_portfolio": "MI UNIVERSO", "details": "DETALLES",
                "story1_title": "El Origen",
                "story1_text": "En 2015, en el instituto nos mandaron hacer un trabajo de fotografiar algo que nos recordase a la filosofía. Yo hice esta foto, sin saber que eso me llevaría a lo que soy hoy. Escribí sobre la soledad, diciendo que nos podría destruir o que nos permitiría apreciar las cosas mucho más.",
                "story2_title": "La Gravedad",
                "story2_text": "Lo relacioné con las estrellas, que por muy aisladas que se encuentren no dejan de brillar. Desde ese momento mi amor por el universo no dejó de expandirse. Esa intriga por lo aún desconocido se vió sometida a la atracción de mi gravedad.",
                "story3_title": "La Historia",
                "story3_text": "Permitiendo la liberación de energía del horizonte de sucesos, que acabaron formando un gran cumulo estelar. Una imágen vale más que mil palabras, y todas estas formarán mi historía.",
                "equip_title": "Mi Equipo", "eq_dig_tel": "Telescopio Digital", "eq_tel": "Telescopio", "eq_cam": "Cámara", "eq_tripod": "Trípode", "eq_mount": "Montura Eq",
                "profile_title": "Perfil Profesional", "exp_title": "Experiencia", "skills_title": "Competencias Clave", "edu_title": "Educación",
                "job1_role": "Ingeniero y Arquitecto de IA", "job1_place": "Grupo Hotelero Multinacional", "job1_date": "May 2025 - Presente",
                "job1_desc": "Liderando estrategias de adopción de IA, definiendo la gobernanza corporativa para IA Generativa y desplegando soluciones LLM (Gemini) en departamentos globales para automatizar flujos de trabajo complejos.",
                "job2_role": "Científico de Datos", "job2_place": "Firma de Ingeniería e Innovación", "job2_date": "Abr 2024 - Oct 2024",
                "job2_desc": "Desarrollo de modelos de Visión por Computador (YOLO, Detectron) para digitalizar activos de infraestructura vial a partir de terabytes de datos visuales.",
                "job3_role": "Analista de Datos", "job3_place": "Servicios Públicos", "job3_date": "Oct 2022 - May 2023",
                "job3_desc": "Optimización de la eficiencia de la flota e informes ambientales utilizando herramientas de BI y análisis estadístico para infraestructura urbana a gran escala.",
                "edu1_role": "Máster en Inteligencia Artificial", "edu1_place": "Universitat de les Illes Balears",
                "edu2_role": "Grado en Ing. Electrónica Industrial", "edu2_place": "Universitat de les Illes Balears",
                "contact_quote": "\"En algún lugar, algo increíble está esperando ser conocido.\"",
                "lb_obj": "OBJETO", "lb_date": "FECHA", "lb_exp": "EXPOSICIÓN", "lb_equip": "EQUIPO",
                "zoom_hint": "Rueda para zoom, Arrastra para mover", "filter_all": "Todo",
                "cat_moon": "Luna", "cat_dso": "Cielo Profundo", "cat_landscape": "Paisajes", "cat_planets": "Planetas",
                "cat_nebulae": "Nebulosas", "cat_galaxies": "Galaxias", "cat_starclusters": "Cúmulos", "cat_solar": "Sol", "cat_sky": "Cielo"
            }
        };

        let currentLang = 'es';
        let currentImageIndex = 0;
        let isMobile = window.innerWidth <= 768;
        
        // Select all items (static from Astro build)
        const allItems = Array.from(document.querySelectorAll('.g-item'));

        /* === INIT === */
        document.addEventListener('DOMContentLoaded', () => {
            setLanguage('es');
            initParticles();
            shuffleQuotes();
            initZoomLogic();
        });

        window.addEventListener('resize', () => { isMobile = window.innerWidth <= 768; });

        /* === LANGUAGE HANDLING === */
        function setLanguage(lang) {
            currentLang = lang;
            const elements = document.querySelectorAll('[data-t]');
            elements.forEach(function(el) {
                const key = el.getAttribute('data-t');
                if (translations[lang] && translations[lang][key]) {
                    el.textContent = translations[lang][key];
                } else if (key.startsWith('cat_')) {
                    el.textContent = key.replace('cat_', '').charAt(0).toUpperCase() + key.replace('cat_', '').slice(1);
                }
            });

            const btnGal = document.getElementById('btn-gallery');
            const btnUni = document.getElementById('btn-universe');
            if(btnGal) btnGal.textContent = translations[lang].nav_gallery;
            if(btnUni) btnUni.textContent = translations[lang].nav_portfolio;

            document.getElementById('lang-en').classList.toggle('active', lang === 'en');
            document.getElementById('lang-es').classList.toggle('active', lang === 'es');

            updateQuoteDisplay();
            
            // Update Lightbox if open
            if (document.getElementById('lightbox').classList.contains('active')) {
                const item = allItems[currentImageIndex];
                if(item) updateLightboxContent(JSON.parse(item.getAttribute('data-json')));
            }
        }
        
        // Expose to window for inline onclicks if needed
        window.setLanguage = setLanguage;

        /* === FILTERING LOGIC === */
        const filterBtns = document.querySelectorAll('.filter-btn');
        filterBtns.forEach(btn => {
            btn.addEventListener('click', () => {
                const category = btn.getAttribute('data-filter');
                filterBtns.forEach(b => b.classList.remove('active'));
                btn.classList.add('active');

                const yearSections = document.querySelectorAll('.year-section');
                
                yearSections.forEach(section => {
                    let visibleCount = 0;
                    const items = section.querySelectorAll('.g-item');
                    items.forEach(item => {
                        if(category === 'all' || item.classList.contains(category)) {
                            item.style.display = 'block';
                            visibleCount++;
                        } else {
                            item.style.display = 'none';
                        }
                    });
                    section.style.display = (visibleCount === 0) ? 'none' : 'block';
                });
            });
        });

        /* === LIGHTBOX & ZOOM LOGIC === */
        const lightbox = document.getElementById('lightbox');
        const lbImg = document.getElementById('lb-img');
        const lbContainer = document.querySelector('.lb-image-container');

        // Attach Click to Items
        allItems.forEach((item, index) => {
            item.addEventListener('click', () => {
                currentImageIndex = index;
                const data = JSON.parse(item.getAttribute('data-json'));
                openLightbox(data);
            });
        });

        function openLightbox(data) {
            updateLightboxContent(data);
            lightbox.classList.add('active');
            document.body.classList.add('no-scroll'); 
            resetZoom(); 
        }

        function closeLightbox() {
            lightbox.classList.remove('active');
            document.body.classList.remove('no-scroll');
            resetZoom();
        }
        
        // Expose for HTML onclick
        window.closeLightbox = closeLightbox;

        function updateLightboxContent(data) {
            const ext = data.src.split('.').pop();
            const thumbSrc = data.src.replace(`.${ext}`, `_thumb.webp`);
            
            // Try thumb first
            lbImg.src = thumbSrc; 
            
            // Load High Res
            const highResImg = new Image();
            highResImg.src = data.src;
            highResImg.onload = () => {
                 if(document.getElementById('lightbox').classList.contains('active')) {
                     lbImg.src = data.src;
                 }
            };

            const title = currentLang === 'en' ? data.title_en : data.title_es;
            const story = currentLang === 'en' ? data.story_en : data.story_es;
            const objName = currentLang === 'en' ? (data.object_en || data.object_es) : data.object_es;

            document.getElementById('lb-title').innerText = title || objName;
            
            const storyContainer = document.getElementById('lb-story-container');
            const storyText = document.getElementById('lb-story-text');
            
            if (story && story.trim() !== "") {
                storyContainer.style.display = 'block';
                storyText.innerText = story;
            } else {
                storyContainer.style.display = 'none';
            }

            function updateSpec(idSpan, idParent, val) {
                const el = document.getElementById(idSpan);
                const parent = document.getElementById(idParent);
                if(!val || val.trim() === "") parent.style.display = 'none';
                else {
                    parent.style.display = 'block';
                    el.innerText = val;
                }
            }

            updateSpec('val-obj', 'spec-obj', objName);
            updateSpec('val-date', 'spec-date', data.date);
            updateSpec('val-exp', 'spec-exp', data.exposure);
            updateSpec('val-equip', 'spec-equip', data.equipment);
        }

        // Navigation
        document.querySelector('.prev-btn').addEventListener('click', () => changeImage(-1));
        document.querySelector('.next-btn').addEventListener('click', () => changeImage(1));

        function changeImage(direction) {
            let nextIndex = currentImageIndex;
            let found = false;
            let loopCount = 0;
            const maxLoops = allItems.length + 1;

            // Find next visible image (skip hidden ones by filter)
            while(!found && loopCount < maxLoops) {
                nextIndex += direction;
                if (nextIndex < 0) nextIndex = allItems.length - 1;
                if (nextIndex >= allItems.length) nextIndex = 0;

                if(allItems[nextIndex].style.display !== 'none') {
                    found = true;
                    currentImageIndex = nextIndex;
                }
                loopCount++;
            }
            
            if(found) {
                const data = JSON.parse(allItems[currentImageIndex].getAttribute('data-json'));
                updateLightboxContent(data);
                resetZoom();
            }
        }

        // --- ZOOM IMPL ---
        let scale = 1, panning = false, pointX = 0, pointY = 0, startX = 0, startY = 0;

        function initZoomLogic() {
            const wrapper = document.querySelector('.lb-image-wrapper');
            if(!wrapper) return;

            wrapper.addEventListener('wheel', (e) => {
                e.preventDefault();
                const xs = (e.offsetX - pointX) / scale;
                const ys = (e.offsetY - pointY) / scale;
                const delta = -Math.sign(e.deltaY) * 0.2;
                const oldScale = scale;
                scale += delta;
                scale = Math.min(Math.max(1, scale), 5); 

                if (scale > 1) {
                    pointX += xs * (scale - oldScale); 
                    pointY += ys * (scale - oldScale);
                } else {
                    pointX = 0; pointY = 0;
                }
                setTransform();
            });

            wrapper.addEventListener('mousedown', (e) => {
                if(scale > 1) {
                    e.preventDefault();
                    startX = e.clientX - pointX;
                    startY = e.clientY - pointY;
                    panning = true;
                    wrapper.style.cursor = "grabbing";
                }
            });

            wrapper.addEventListener('mousemove', (e) => {
                if (!panning) return;
                e.preventDefault();
                pointX = e.clientX - startX;
                pointY = e.clientY - startY;
                setTransform();
            });

            wrapper.addEventListener('mouseup', () => { panning = false; wrapper.style.cursor = "grab"; });
            wrapper.addEventListener('mouseleave', () => { panning = false; wrapper.style.cursor = "grab"; });
        }

        function setTransform() { lbContainer.style.transform = `translate(${pointX}px, ${pointY}px) scale(${scale})`; }
        function resetZoom() { scale = 1; pointX = 0; pointY = 0; panning = false; setTransform(); }

        // Keyboard & Click Outside
        document.addEventListener('keydown', (e) => {
            if (!lightbox.classList.contains('active')) return;
            if (e.key === "Escape") closeLightbox();
            if (e.key === "ArrowLeft") changeImage(-1);
            if (e.key === "ArrowRight") changeImage(1);
        });

        lightbox.addEventListener('click', (e) => {
            if(e.target === lightbox || e.target.classList.contains('lb-content')) closeLightbox();
        });
        
        // Mobile Swipe
        let touchStartX = 0;
        lightbox.addEventListener('touchstart', (e) => { touchStartX = e.changedTouches[0].screenX; }, {passive: true});
        lightbox.addEventListener('touchend', (e) => {
            if (e.changedTouches[0].screenX < touchStartX - 50) changeImage(1);
            if (e.changedTouches[0].screenX > touchStartX + 50) changeImage(-1);
        }, {passive: true});


        /* === NAV & SCROLL === */
        const navbar = document.getElementById('navbar');
        const scrollTopBtn = document.getElementById('scroll-top-btn');
        let lastScrollY = window.scrollY;

        window.addEventListener('scroll', () => {
            const currentScrollY = window.scrollY;
            if (currentScrollY > lastScrollY && currentScrollY > 100) navbar.classList.add('nav-hidden');
            else navbar.classList.remove('nav-hidden');
            
            if (currentScrollY > 50) navbar.classList.add('nav-faded');
            else navbar.classList.remove('nav-faded');

            if (currentScrollY > 500) scrollTopBtn.classList.add('visible');
            else scrollTopBtn.classList.remove('visible');

            lastScrollY = currentScrollY;
        }, {passive: true});

        // Tab Switching
        const btnGallery = document.getElementById('btn-gallery');
        const btnUniverse = document.getElementById('btn-universe');
        const galleryTab = document.getElementById('gallery-tab');
        const portfolioTab = document.getElementById('portfolio-tab');

        function switchTab(tabName) {
            if(tabName === 'gallery') {
                galleryTab.classList.remove('hidden');
                galleryTab.classList.add('fade-in');
                portfolioTab.classList.add('hidden');
                btnGallery.classList.add('active');
                btnUniverse.classList.remove('active');
            } else {
                portfolioTab.classList.remove('hidden');
                portfolioTab.classList.add('fade-in');
                galleryTab.classList.add('hidden');
                btnUniverse.classList.add('active');
                btnGallery.classList.remove('active');
            }
        }
        
        btnGallery.addEventListener('click', () => switchTab('gallery'));
        btnUniverse.addEventListener('click', () => switchTab('portfolio'));

        /* === PARTICLES === */
        function initParticles() {
            const canvas = document.getElementById('bg-canvas');
            const ctx = canvas.getContext('2d');
            let width, height, particles = [];
            const particleCount = isMobile ? 30 : 150;
            let mouse = { x: null, y: null }, mouseActive = false;

            function resize() { width = canvas.width = window.innerWidth; height = canvas.height = window.innerHeight; }
            window.addEventListener('resize', resize);
            resize();

            window.addEventListener('mousemove', e => {
                mouse.x = e.clientX; mouse.y = e.clientY; mouseActive = true;
                clearTimeout(window.mouseTimer); window.mouseTimer = setTimeout(() => { mouseActive = false; }, 2000);
            });

            class Particle {
                constructor() {
                    this.x = Math.random() * width; this.y = Math.random() * height;
                    this.vx = (Math.random() - 0.5) * 0.2; this.vy = (Math.random() - 0.5) * 0.2;
                    this.size = Math.random() * 1.5; this.angle = Math.random() * Math.PI * 2;
                }
                update() {
                    if (mouseActive && mouse.x != null && !isMobile) {
                        const dx = mouse.x - this.x, dy = mouse.y - this.y;
                        const dist = Math.sqrt(dx * dx + dy * dy);
                        if (dist < 200) {
                            const angle = Math.atan2(dy, dx);
                            const force = (width * 0.1) / dist;
                            this.vx += Math.cos(angle) * force * 0.01;
                            this.vy += Math.sin(angle) * force * 0.01;
                        }
                    } else {
                        this.angle += 0.01;
                        this.vx += Math.cos(this.angle) * 0.001;
                        this.vy += Math.sin(this.angle) * 0.001;
                    }
                    this.vx *= 0.98; this.vy *= 0.98;
                    this.x += this.vx; this.y += this.vy;
                    if (this.x < 0) this.x = width; if (this.x > width) this.x = 0;
                    if (this.y < 0) this.y = height; if (this.y > height) this.y = 0;
                }
                draw() {
                    ctx.fillStyle = `rgba(255, 255, 255, ${Math.random() * 0.5 + 0.2})`;
                    ctx.beginPath(); ctx.arc(this.x, this.y, this.size, 0, Math.PI * 2); ctx.fill();
                }
            }

            for (let i = 0; i < particleCount; i++) particles.push(new Particle());
            function animate() {
                ctx.clearRect(0, 0, width, height);
                particles.forEach(p => { p.update(); p.draw(); });
                requestAnimationFrame(animate);
            }
            animate();
        }

        /* === QUOTES === */
        const quotes = [
            { text_en: "\"We are made of starstuff.\"", text_es: "\"Estamos hechos de polvo de estrellas.\"", author: "- Carl Sagan" },
            { text_en: "\"Somewhere, something incredible is waiting to be known.\"", text_es: "\"En algún lugar, algo increíble espera ser descubierto.\"", author: "- Carl Sagan" },
            { text_en: "\"The universe is under no obligation to make sense to you.\"", text_es: "\"El universo no tiene la obligación de tener sentido para ti.\"", author: "- Neil deGrasse Tyson" },
            { text_en: "\"Look deep into nature, and then you will understand everything better.\"", text_es: "\"Mira profundamente en la naturaleza y entonces entenderás todo mejor.\"", author: "- Albert Einstein" }
        ];

        let quoteIndex = 0;
        const quoteTextEl = document.getElementById('quote-text');
        const quoteAuthEl = document.getElementById('quote-author');

        function shuffleQuotes() {
            for (let i = quotes.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [quotes[i], quotes[j]] = [quotes[j], quotes[i]];
            }
        }
        function updateQuoteDisplay() {
            if(!quoteTextEl) return;
            const q = quotes[quoteIndex];
            quoteTextEl.textContent = currentLang === 'en' ? q.text_en : q.text_es;
            quoteAuthEl.textContent = q.author;
        }
        function cycleQuotes() {
            quoteTextEl.classList.remove('visible'); quoteAuthEl.classList.remove('visible');
            setTimeout(() => {
                quoteIndex = (quoteIndex + 1) % quotes.length;
                if(quoteIndex === 0) shuffleQuotes();
                updateQuoteDisplay();
                quoteTextEl.classList.add('visible'); quoteAuthEl.classList.add('visible');
            }, 1000);
        }
        setTimeout(() => {
            if(quoteTextEl) quoteTextEl.classList.add('visible');
            if(quoteAuthEl) quoteAuthEl.classList.add('visible');
            setInterval(cycleQuotes, 8000);
        }, 3000);
    </script>
</Layout>
