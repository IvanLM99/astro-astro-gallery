---
import { getRelativeLocaleUrl } from 'astro:i18n';

const { activeTab = 'gallery', lang = 'es' } = Astro.props;

// BEST PRACTICE: Use Astro's built-in helper for i18n URLs. 
// This automatically handles the 'base' path and the language prefix.
const homeUrl = getRelativeLocaleUrl(lang, '');
const galleryUrl = getRelativeLocaleUrl(lang, 'gallery');
const universeUrl = getRelativeLocaleUrl(lang, 'universe');
---

<nav id="navbar">
    <div class="nav-left">
        <a href={homeUrl} class="site-title">I. LOPEZ</a>
    </div>

    <div class="nav-center">
        <a href={galleryUrl} class={`menu-btn ${activeTab === 'gallery' ? 'active' : ''}`} id="btn-gallery" data-t="nav_gallery">GALER√çA</a>
        <a href={universeUrl} class={`menu-btn ${activeTab === 'universe' ? 'active' : ''}`} id="btn-universe" data-t="nav_portfolio">MI UNIVERSO</a>
    </div>

    <div class="nav-right">
        <div class="lang-select">
            <span id="lang-en" class={`lang ${lang === 'en' ? 'active' : ''}`} data-lang="en">EN</span> /
            <span id="lang-es" class={`lang ${lang === 'es' ? 'active' : ''}`} data-lang="es">ES</span>
        </div>
    </div>
</nav>

<script define:vars={{ currentLang: lang, baseUrl: import.meta.env.BASE_URL }}>
    import { translations } from '../data/translations.js';

    // Scroll to top on page load/refresh (fixes tab switch scroll issue)
    if ('scrollRestoration' in history) {
        history.scrollRestoration = 'manual';
    }
    window.scrollTo(0, 0);

    // Navbar scroll hide/show
    const navbar = document.getElementById('navbar');
    let lastScrollY = window.scrollY;

    window.addEventListener('scroll', () => {
        const currentScrollY = window.scrollY;
        if(navbar) {
            if (currentScrollY > lastScrollY && currentScrollY > 100) {
                navbar.classList.add('nav-hidden');
            } else {
                navbar.classList.remove('nav-hidden');
            }
            if (currentScrollY > 50) {
                navbar.classList.add('nav-faded');
            } else {
                navbar.classList.remove('nav-faded');
            }

            const stBtn = document.getElementById('scroll-top-btn');
            if(stBtn) {
                 if(currentScrollY > 500) stBtn.classList.add('visible');
                 else stBtn.classList.remove('visible');
            }
        }
        lastScrollY = currentScrollY;
    }, {passive: true});

    // Language Logic
    const langEn = document.getElementById('lang-en');
    const langEs = document.getElementById('lang-es');
    
    function setLanguage(targetLang) {
        if (targetLang === currentLang) return;

        localStorage.setItem('preferred-lang', targetLang);
        
        // CLEANER URL REPLACEMENT logic
        // Get current path relative to the site
        let path = window.location.pathname;
        
        // Remove the Base URL from the path for manipulation
        // e.g. "/astro-astro-gallery/en/gallery" -> "/en/gallery"
        if (path.startsWith(baseUrl)) {
            path = path.slice(baseUrl.length);
        }

        // Logic to switch language prefix
        // If we are switching TO English
        if (targetLang === 'en') {
             // If currently root (spanish default), add /en
             if (!path.startsWith('/en')) {
                 path = '/en' + path;
             }
        } 
        // If switching TO Spanish (default)
        else if (targetLang === 'es') {
            // Remove /en if it exists
            path = path.replace(/^\/en/, '') || '/';
        }

        // Construct full URL ensuring double slashes don't happen
        const finalUrl = (baseUrl + path).replace(/\/\//g, '/');
        
        window.location.href = finalUrl + window.location.search;
    }

    langEn?.addEventListener('click', () => setLanguage('en'));
    langEs?.addEventListener('click', () => setLanguage('es'));
</script>
