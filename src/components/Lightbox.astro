<div id="lightbox">
    <span class="close-lb" id="lb-close" aria-label="Close Lightbox">&times;</span>
    <button class="lb-nav-btn prev-btn" id="lb-prev" aria-label="Previous Image"><i class="fas fa-chevron-left"></i></button>
    <button class="lb-nav-btn next-btn" id="lb-next" aria-label="Next Image"><i class="fas fa-chevron-right"></i></button>

    <div class="lb-content">
        <div class="lb-image-wrapper">
            <div class="lb-image-container">
                <img id="lb-img" src="" alt="Expanded View">
            </div>
        </div>
        
        <div class="lb-info">
            <h2 id="lb-title">Object Name</h2>
            
            <div id="lb-story-container" class="lb-story">
                <i class="fas fa-quote-left story-icon"></i>
                <p id="lb-story-text"></p>
            </div>

            <div class="tech-specs">
                <div class="spec" id="spec-obj">
                    <span data-t="lb_obj">OBJECT</span>
                    <span id="val-obj">--</span>
                </div>
                <div class="spec" id="spec-date">
                    <span data-t="lb_date">DATE</span>
                    <span id="val-date">--</span>
                </div>
                <div class="spec" id="spec-exp">
                    <span data-t="lb_exp">EXPOSURE</span>
                    <span id="val-exp">--</span>
                </div>
                <div class="spec" id="spec-equip">
                    <span data-t="lb_equip">EQUIPMENT</span>
                    <span id="val-equip">--</span>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    import { translations } from '../data/translations.js';

    let currentLang = 'es';
    let currentIndex = 0;
    
    const lightbox = document.getElementById('lightbox');
    const lbImg = document.getElementById('lb-img');
    const lbTitle = document.getElementById('lb-title');
    const lbStoryContainer = document.getElementById('lb-story-container');
    const lbStoryText = document.getElementById('lb-story-text');
    const lbContainer = document.querySelector('.lb-image-container');
    const lbWrapper = document.querySelector('.lb-image-wrapper');

    // Global Events
    window.addEventListener('langChange', (e) => {
        currentLang = e.detail.lang;
        if(lightbox.classList.contains('active')) updateContent();
    });

    window.addEventListener('openLightbox', (e) => {
        const id = e.detail.id;
        const thumbSrc = e.detail.thumbSrc;
        const data = window.galleryData || [];
        
        currentIndex = data.findIndex(i => i.id === id);
        
        if(currentIndex !== -1) {
            lightbox.classList.add('active');
            document.body.classList.add('no-scroll');
            
            // Set thumbnail immediately
            if(thumbSrc) {
                lbImg.src = thumbSrc;
                lbImg.classList.add('blur-loading');
            }
            
            updateContent(true); 
            resetZoom();
        }
    });

    function updateContent(isInitialLoad = false) {
        const data = window.galleryData[currentIndex];
        if(!data) return;

        // Image Swapping
        if(!isInitialLoad) {
            if(data.thumbnailSrc) {
                lbImg.src = data.thumbnailSrc; 
                lbImg.classList.add('blur-loading');
            } else {
                lbImg.style.opacity = '0'; 
            }
        }

        // High Res Loader
        const highResLoader = new Image();
        highResLoader.src = data.src;
        highResLoader.onload = () => {
            if(window.galleryData[currentIndex].id === data.id) {
                lbImg.src = data.src;
                lbImg.classList.remove('blur-loading');
                lbImg.style.opacity = '1';
            }
        };

        // Text Logic
        const title = currentLang === 'en' ? data.title_en : data.title_es;
        const story = currentLang === 'en' ? data.story_en : data.story_es;
        const objName = currentLang === 'en' ? (data.object_en || data.object_es) : data.object_es;

        if(lbTitle) lbTitle.innerText = title || objName;

        if (story && story.trim() !== "") {
            lbStoryContainer.style.display = 'block';
            lbStoryText.innerText = story;
        } else {
            lbStoryContainer.style.display = 'none';
        }

        // Update Specs
        updateSpec('spec-obj', 'val-obj', objName);
        updateSpec('spec-date', 'val-date', data.date);
        updateSpec('spec-exp', 'val-exp', data.exposure);
        updateSpec('spec-equip', 'val-equip', data.equipment);
        
        // Translate Labels
        const specs = ['lb_obj', 'lb_date', 'lb_exp', 'lb_equip'];
        specs.forEach(key => {
            const el = document.querySelector(`[data-t="${key}"]`);
            if(el) el.textContent = translations[currentLang][key];
        });
    }

    function updateSpec(idContainer, idVal, value) {
        const container = document.getElementById(idContainer);
        const valEl = document.getElementById(idVal);
        if(!value || value.trim() === "") {
            container.style.display = 'none';
        } else {
            container.style.display = 'block';
            valEl.innerText = value;
        }
    }

    function changeImage(dir) {
        const data = window.galleryData;
        currentIndex += dir;
        if (currentIndex < 0) currentIndex = data.length - 1;
        if (currentIndex >= data.length) currentIndex = 0;
        updateContent();
        resetZoom();
    }

    document.getElementById('lb-prev')?.addEventListener('click', () => changeImage(-1));
    document.getElementById('lb-next')?.addEventListener('click', () => changeImage(1));
    document.getElementById('lb-close')?.addEventListener('click', closeLightbox);

    function closeLightbox() {
        lightbox.classList.remove('active');
        document.body.classList.remove('no-scroll');
        setTimeout(() => { lbImg.src = ''; }, 300);
    }

    // === MOBILE SWIPE GESTURES ===
    let touchStartX = 0;
    let touchEndX = 0;

    lightbox.addEventListener('touchstart', (e) => {
        touchStartX = e.changedTouches[0].screenX;
    }, {passive: true});

    lightbox.addEventListener('touchend', (e) => {
        touchEndX = e.changedTouches[0].screenX;
        handleSwipe();
    }, {passive: true});

    function handleSwipe() {
        if (touchEndX < touchStartX - 50) {
            changeImage(1); // Swipe Left -> Next
        }
        if (touchEndX > touchStartX + 50) {
            changeImage(-1); // Swipe Right -> Prev
        }
    }

    // === ZOOM LOGIC ===
    let scale = 1, pointX = 0, pointY = 0, panning = false, startX = 0, startY = 0;

    function resetZoom() {
        scale = 1; pointX = 0; pointY = 0; panning = false;
        lbContainer.style.transform = `translate(0px, 0px) scale(1)`;
    }

    if(lbWrapper) {
        lbWrapper.addEventListener('wheel', (e) => {
            e.preventDefault();
            const xs = (e.offsetX - pointX) / scale;
            const ys = (e.offsetY - pointY) / scale;
            const delta = -Math.sign(e.deltaY) * 0.2;
            const oldScale = scale;
            scale += delta;
            scale = Math.min(Math.max(1, scale), 5);
            if (scale > 1) {
                pointX += xs * (scale - oldScale);
                pointY += ys * (scale - oldScale);
            } else {
                pointX = 0; pointY = 0;
            }
            lbContainer.style.transform = `translate(${pointX}px, ${pointY}px) scale(${scale})`;
        });

        lbWrapper.addEventListener('mousedown', (e) => {
            if(scale > 1) {
                e.preventDefault();
                startX = e.clientX - pointX;
                startY = e.clientY - pointY;
                panning = true;
                lbWrapper.style.cursor = "grabbing";
            }
        });

        lbWrapper.addEventListener('mousemove', (e) => {
            if (!panning) return;
            e.preventDefault();
            pointX = e.clientX - startX;
            pointY = e.clientY - startY;
            lbContainer.style.transform = `translate(${pointX}px, ${pointY}px) scale(${scale})`;
        });

        lbWrapper.addEventListener('mouseup', () => { panning = false; lbWrapper.style.cursor = "grab"; });
        lbWrapper.addEventListener('mouseleave', () => { panning = false; lbWrapper.style.cursor = "grab"; });
    }

    document.addEventListener('keydown', (e) => {
        if (!lightbox.classList.contains('active')) return;
        if (e.key === "Escape") closeLightbox();
        if (e.key === "ArrowLeft") changeImage(-1);
        if (e.key === "ArrowRight") changeImage(1);
    });
</script>
